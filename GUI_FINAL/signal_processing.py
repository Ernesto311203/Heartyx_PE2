import numpy as np
import pandas as pd
from scipy.signal import lfilter, find_peaks, butter, filtfilt, sosfiltfilt, welch
import tensorflow as tf
from tensorflow.keras.models import load_model
from config import MODEL_PATH

try:
    BP_MODEL = load_model(MODEL_PATH, compile=False)
    print("Modelo IA cargado correctamente.")
except Exception as e:
    print(f"Advertencia: No se pudo cargar {MODEL_PATH}. Error: {e}")
    BP_MODEL = None

FIR_COEFFS_BPM = np.array([
    7.17109204e-05, 6.21026777e-05, 4.95393904e-05, 3.45637162e-05, 1.78131758e-05, -1.76323170e-19, -1.81117771e-05, -3.57313864e-05,
    -5.20678859e-05, -6.63574760e-05, -7.78907707e-05, -8.60391821e-05, -9.02795508e-05, -9.02161516e-05, -8.55992252e-05, -7.63392386e-05,
    -6.25161603e-05, -4.43831481e-05, -2.23641989e-05, 2.95451706e-06, 3.08397045e-05, 6.04322181e-05, 9.07741635e-05, 1.20841173e-04,
    1.49578961e-04, 1.75943033e-04, 1.98940207e-04, 2.17670452e-04, 2.31367408e-04, 2.39435904e-04, 2.41484784e-04, 2.37353423e-04,
    2.27130456e-04, 2.11163491e-04, 1.90058827e-04, 1.64670569e-04, 1.36078959e-04, 1.05558135e-04, 7.45340306e-05, 4.45335817e-05,
    1.71268392e-05, -6.13599558e-06, -2.37902601e-05, -3.45226283e-05, -3.72342357e-05, -3.10982974e-05, -1.56094526e-05, 9.37773904e-06,
    4.36234056e-05, 8.64918978e-05, 1.36957531e-04, 1.93627188e-04, 2.54779737e-04, 3.18421493e-04, 3.82356218e-04, 4.44267421e-04,
    5.01810086e-04, 5.52708376e-04, 5.94855431e-04, 6.26411065e-04, 6.45893044e-04, 6.52257695e-04, 6.44965808e-04, 6.24030260e-04,
    5.90042378e-04, 5.44174834e-04, 4.88159794e-04, 4.24242013e-04, 3.55107691e-04, 2.83790953e-04, 2.13560899e-04, 1.47793158e-04,
    8.98307287e-05, 4.28395760e-05, 9.66497342e-06, -7.30521930e-06, -6.26412511e-06, 1.39096515e-05, 5.35719671e-05, 1.12262083e-04,
    1.88684122e-04, 2.80723314e-04, 3.85497886e-04, 4.99445987e-04, 6.18445459e-04, 7.37962802e-04, 8.53226211e-04, 9.59416353e-04,
    1.05186749e-03, 1.12627076e-03, 1.17887113e-03, 1.20664916e-03, 1.20747935e-03, 1.18025717e-03, 1.12498824e-03, 1.04283395e-03,
    9.36110165e-04, 8.08236741e-04, 6.63638290e-04, 5.07598201e-04, 3.46070325e-04, 1.85454590e-04, 3.23446041e-05, -1.06743141e-04,
    -2.25647721e-04, -3.18838369e-04, -3.81673425e-04, -4.10632030e-04, -4.03507700e-04, -3.59554090e-04, -2.79574905e-04, -1.65952012e-04,
    -2.26081493e-05, 1.45096682e-04, 3.30533329e-04, 5.26031461e-04, 7.23160071e-04, 9.13050666e-04, 1.08675115e-03, 1.23559663e-03,
    1.35158221e-03, 1.42772214e-03, 1.45837972e-03, 1.43955300e-03, 1.36910272e-03, 1.24691067e-03, 1.07495942e-03, 8.57327091e-04,
    6.00094351e-04, 3.11164362e-04, -1.55343404e-18, -3.22713580e-04, -6.45469642e-04, -9.56389333e-04, -1.24370290e-03, -1.49624365e-03,
    -1.70393464e-03, -1.85824725e-03, -1.95261190e-03, -1.98276177e-03, -1.94699307e-03, -1.84632796e-03, -1.68456998e-03, -1.46824594e-03,
    -1.20643257e-03, -9.10471333e-04, -5.93579056e-04, -2.70367152e-04, 4.37139998e-05, 3.32985009e-04, 5.82178425e-04, 7.77085226e-04,
    9.05180312e-04, 9.56200422e-04, 9.22648951e-04, 8.00204311e-04, 5.88011666e-04, 2.88841959e-04, -9.08928616e-05, -5.41274038e-04,
    -1.04915924e-03, -1.59860835e-03, -2.17143918e-03, -2.74789487e-03, -3.30739938e-03, -3.82937312e-03, -4.29407747e-03, -4.68345453e-03,
    -4.98192770e-03, -5.17712883e-03, -5.26051989e-03, -5.22788005e-03, -5.07963363e-03, -4.82099995e-03, -4.46195300e-03, -4.01698568e-03,
    -3.50468143e-03, -2.94710398e-03, -2.36902340e-03, -1.79700416e-03, -1.25838718e-03, -7.80203175e-04, -3.88058836e-04, -1.05039740e-04,
    4.93252915e-05, 5.99944730e-05, -8.28031375e-05, -3.82967029e-04, -8.38138497e-04, -1.43955100e-03, -2.17213223e-03, -3.01486298e-03,
    -3.94138807e-03, -4.92086418e-03, -5.91901983e-03, -6.89939344e-03, -7.82470715e-03, -8.65832728e-03, -9.36575740e-03, -9.91610640e-03,
    -1.02834733e-02, -1.04481916e-02, -1.03978787e-02, -1.01282436e-02, -9.64361001e-03, -8.95712575e-03, -8.09063713e-03, -7.07422009e-03,
    -5.94537266e-03, -4.74788640e-03, -3.53042656e-03, -2.34486342e-03, -1.24440749e-03, -2.81610674e-04, 4.93697578e-04, 1.03646522e-03,
    1.30838772e-03, 1.27971792e-03, 9.30843490e-04, 2.53566248e-04, -7.47974232e-04, -2.05677879e-03, -3.64290207e-03, -5.46381990e-03,
    -7.46525394e-03, -9.58244065e-03, -1.17418158e-02, -1.38630701e-02, -1.58615174e-02, -1.76507046e-02, -1.91451814e-02, -2.02633424e-02,
    -2.09302454e-02, -2.10803136e-02, -2.06598260e-02, -1.96291086e-02, -1.79643461e-02, -1.56589444e-02, -1.27243894e-02, -9.19056121e-03,
    -5.10548205e-03, -5.34494388e-04, 4.44111656e-03, 9.72602177e-03, 1.52132177e-02, 2.07867983e-02, 2.63250486e-02, 3.17037661e-02,
    3.67997089e-02, 4.14940639e-02, 4.56758262e-02, 4.92449837e-02, 5.21154058e-02, 5.42173454e-02, 5.54994715e-02, 5.59303717e-02,
    5.54994715e-02, 5.42173454e-02, 5.21154058e-02, 4.92449837e-02, 4.56758262e-02, 4.14940639e-02, 3.67997089e-02, 3.17037661e-02,
    2.63250486e-02, 2.07867983e-02, 1.52132177e-02, 9.72602177e-03, 4.44111656e-03, -5.34494388e-04, -5.10548205e-03, -9.19056121e-03,
    -1.27243894e-02, -1.56589444e-02, -1.79643461e-02, -1.96291086e-02, -2.06598260e-02, -2.10803136e-02, -2.09302454e-02, -2.02633424e-02,
    -1.91451814e-02, -1.76507046e-02, -1.58615174e-02, -1.38630701e-02, -1.17418158e-02, -9.58244065e-03, -7.46525394e-03, -5.46381990e-03,
    -3.64290207e-03, -2.05677879e-03, -7.47974232e-04, 2.53566248e-04, 9.30843490e-04, 1.27971792e-03, 1.30838772e-03, 1.03646522e-03,
    4.93697578e-04, -2.81610674e-04, -1.24440749e-03, -2.34486342e-03, -3.53042656e-03, -4.74788640e-03, -5.94537266e-03, -7.07422009e-03,
    -8.09063713e-03, -8.95712575e-03, -9.64361001e-03, -1.01282436e-02, -1.03978787e-02, -1.04481916e-02, -1.02834733e-02, -9.91610640e-03,
    -9.36575740e-03, -8.65832728e-03, -7.82470715e-03, -6.89939344e-03, -5.91901983e-03, -4.92086418e-03, -3.94138807e-03, -3.01486298e-03,
    -2.17213223e-03, -1.43955100e-03, -8.38138497e-04, -3.82967029e-04, -8.28031375e-05, 5.99944730e-05, 4.93252915e-05, -1.05039740e-04,
    -3.88058836e-04, -7.80203175e-04, -1.25838718e-03, -1.79700416e-03, -2.36902340e-03, -2.94710398e-03, -3.50468143e-03, -4.01698568e-03,
    -4.46195300e-03, -4.82099995e-03, -5.07963363e-03, -5.22788005e-03, -5.26051989e-03, -5.17712883e-03, -4.98192770e-03, -4.68345453e-03,
    -4.29407747e-03, -3.82937312e-03, -3.30739938e-03, -2.74789487e-03, -2.17143918e-03, -1.59860835e-03, -1.04915924e-03, -5.41274038e-04,
    -9.08928616e-05, 2.88841959e-04, 5.88011666e-04, 8.00204311e-04, 9.22648951e-04, 9.56200422e-04, 9.05180312e-04, 7.77085226e-04,
    5.82178425e-04, 3.32985009e-04, 4.37139998e-05, -2.70367152e-04, -5.93579056e-04, -9.10471333e-04, -1.20643257e-03, -1.46824594e-03,
    -1.68456998e-03, -1.84632796e-03, -1.94699307e-03, -1.98276177e-03, -1.95261190e-03, -1.85824725e-03, -1.70393464e-03, -1.49624365e-03,
    -1.24370290e-03, -9.56389333e-04, -6.45469642e-04, -3.22713580e-04, -1.55343404e-18, 3.11164362e-04, 6.00094351e-04, 8.57327091e-04,
    1.07495942e-03, 1.24691067e-03, 1.36910272e-03, 1.43955300e-03, 1.45837972e-03, 1.42772214e-03, 1.35158221e-03, 1.23559663e-03,
    1.08675115e-03, 9.13050666e-04, 7.23160071e-04, 5.26031461e-04, 3.30533329e-04, 1.45096682e-04, -2.26081493e-05, -1.65952012e-04,
    -2.79574905e-04, -3.59554090e-04, -4.03507700e-04, -4.10632030e-04, -3.81673425e-04, -3.18838369e-04, -2.25647721e-04, -1.06743141e-04,
    3.23446041e-05, 1.85454590e-04, 3.46070325e-04, 5.07598201e-04, 6.63638290e-04, 8.08236741e-04, 9.36110165e-04, 1.04283395e-03,
    1.12498824e-03, 1.18025717e-03, 1.20747935e-03, 1.20664916e-03, 1.17887113e-03, 1.12627076e-03, 1.05186749e-03, 9.59416353e-04,
    8.53226211e-04, 7.37962802e-04, 6.18445459e-04, 4.99445987e-04, 3.85497886e-04, 2.80723314e-04, 1.88684122e-04, 1.12262083e-04,
    5.35719671e-05, 1.39096515e-05, -6.26412511e-06, -7.30521930e-06, 9.66497342e-06, 4.28395760e-05, 8.98307287e-05, 1.47793158e-04,
    2.13560899e-04, 2.83790953e-04, 3.55107691e-04, 4.24242013e-04, 4.88159794e-04, 5.44174834e-04, 5.90042378e-04, 6.24030260e-04,
    6.44965808e-04, 6.52257695e-04, 6.45893044e-04, 6.26411065e-04, 5.94855431e-04, 5.52708376e-04, 5.01810086e-04, 4.44267421e-04,
    3.82356218e-04, 3.18421493e-04, 2.54779737e-04, 1.93627188e-04, 1.36957531e-04, 8.64918978e-05, 4.36234056e-05, 9.37773904e-06,
    -1.56094526e-05, -3.10982974e-05, -3.72342357e-05, -3.45226283e-05, -2.37902601e-05, -6.13599558e-06, 1.71268392e-05, 4.45335817e-05,
    7.45340306e-05, 1.05558135e-04, 1.36078959e-04, 1.64670569e-04, 1.90058827e-04, 2.11163491e-04, 2.27130456e-04, 2.37353423e-04,
    2.41484784e-04, 2.39435904e-04, 2.31367408e-04, 2.17670452e-04, 1.98940207e-04, 1.75943033e-04, 1.49578961e-04, 1.20841173e-04,
    9.07741635e-05, 6.04322181e-05, 3.08397045e-05, 2.95451706e-06, -2.23641989e-05, -4.43831481e-05, -6.25161603e-05, -7.63392386e-05,
    -8.55992252e-05, -9.02161516e-05, -9.02795508e-05, -8.60391821e-05, -7.78907707e-05, -6.63574760e-05, -5.20678859e-05, -3.57313864e-05,
    -1.81117771e-05, -1.76323170e-19, 1.78131758e-05, 3.45637162e-05, 4.95393904e-05, 6.21026777e-05, 7.17109204e-05
])

FIR_COEFFS_SPO2 = np.array([
    4.61739810e-05, 8.06740594e-05, 9.30182449e-05, 8.05450033e-05, 4.66419300e-05, -4.79110815e-19, -4.74237861e-05, -8.32660650e-05,
    -9.77659056e-05, -8.62012261e-05, -5.01531280e-05, 2.73438703e-06, 6.04787218e-05, 1.09588591e-04, 1.38343467e-04, 1.39737726e-04,
    1.13360603e-04, 6.57168497e-05, 8.85512241e-06, -4.24207434e-05, -7.41252123e-05, -7.65993874e-05, -4.70855292e-05, 9.30753536e-06,
    8.05554617e-05, 1.50432887e-04, 2.02394492e-04, 2.23708650e-04, 2.08824079e-04, 1.61092591e-04, 9.23390749e-05, 2.02832472e-05,
    -3.56441375e-05, -5.91182862e-05, -4.11903276e-05, 1.70922504e-05, 1.04458107e-04, 2.01755901e-04, 2.86408226e-04, 3.37957499e-04,
    3.43356649e-04, 3.00651845e-04, 2.20041142e-04, 1.21904873e-04, 3.21506671e-05, -2.40844845e-05, -2.88607255e-05, 2.36359947e-05,
    1.24993789e-04, 2.53984029e-04, 3.81303109e-04, 4.76612389e-04, 5.16202740e-04, 4.89364163e-04, 4.01771459e-04, 2.74870324e-04,
    1.41215650e-04, 3.67434870e-05, -8.20958012e-06, 2.30860644e-05, 1.28809172e-04, 2.88121996e-04, 4.65526215e-04, 6.19170679e-04,
    7.11189351e-04, 7.17534187e-04, 6.34770959e-04, 4.81956152e-04, 2.96875861e-04, 1.27331055e-04, 1.94507266e-05, 5.86865916e-06,
    9.67708441e-05, 2.76232444e-04, 5.05029318e-04, 7.29514078e-04, 8.94580700e-04, 9.57606397e-04, 8.99864854e-04, 7.32386569e-04,
    4.94517500e-04, 2.45207683e-04, 4.89155015e-05, -4.05289186e-05, 5.91375397e-06, 1.83996741e-04, 4.55774605e-04, 7.57738643e-04,
    1.01580978e-03, 1.16367818e-03, 1.15997267e-03, 9.99843243e-04, 7.17769248e-04, 3.80499867e-04, 7.14963325e-05, -1.29534812e-04,
    -1.67026731e-04, -2.46737590e-05, 2.68773609e-04, 6.44903767e-04, 1.01132727e-03, 1.27409518e-03, 1.36144117e-03, 1.24287649e-03,
    9.38601664e-04, 5.16451148e-04, 7.66387056e-05, -2.72321857e-04, -4.40770197e-04, -3.81365779e-04, -1.02770402e-04, 3.30311093e-04,
    8.11283504e-04, 1.21698180e-03, 1.43818365e-03, 1.40778765e-03, 1.11942889e-03, 6.31445067e-04, 5.46213516e-05, -4.73809697e-04,
    -8.23859940e-04, -9.05936178e-04, -6.95038888e-04, -2.39544920e-04, 3.48233051e-04, 9.18011381e-04, 1.31808002e-03, 1.43358192e-03,
    1.21691217e-03, 7.02256132e-04, -3.62861281e-18, -7.28321166e-04, -1.30892727e-03, -1.59922912e-03, -1.52498773e-03, -1.10157747e-03,
    -4.33397984e-04, 3.09216603e-04, 9.30581513e-04, 1.25812689e-03, 1.18679396e-03, 7.08004595e-04, -8.46684077e-05, -1.01540549e-03,
    -1.86751942e-03, -2.43664190e-03, -2.58272197e-03, -2.26767352e-03, -1.56865767e-03, -6.62773780e-04, 2.14006013e-04, 8.24225674e-04,
    9.88770485e-04, 6.34130452e-04, -1.85264723e-04, -1.29616281e-03, -2.44588656e-03, -3.36316579e-03, -3.82584012e-03, -3.71861728e-03,
    -3.06597612e-03, -2.03103270e-03, -8.79433199e-04, 8.38874212e-05, 5.90127237e-04, 4.75662615e-04, -2.72901333e-04, -1.50988604e-03,
    -2.96143740e-03, -4.28982792e-03, -5.17618858e-03, -5.40151637e-03, -4.90550529e-03, -3.80758359e-03, -2.38347679e-03, -1.00155763e-03,
    -3.35127753e-05, 2.39150860e-04, -3.00603379e-04, -1.56965669e-03, -3.29807551e-03, -5.08996726e-03, -6.51834394e-03, -7.23143398e-03,
    -7.04415270e-03, -5.99117026e-03, -4.32675914e-03, -2.46939695e-03, -9.02891150e-04, -5.71625524e-05, -1.97833735e-04, -1.35270585e-03,
    -3.29506515e-03, -5.59030150e-03, -7.69670493e-03, -9.09735319e-03, -9.43126902e-03, -8.59090131e-03, -6.76005696e-03, -4.38024478e-03,
    -2.05081274e-03, -3.85062841e-04, 1.43500780e-04, -6.73315268e-04, -2.71383278e-03, -5.54181545e-03, -8.50146259e-03, -1.08719728e-02,
    -1.20457682e-02, -1.16868994e-02, -9.82905147e-03, -6.88570691e-03, -3.56559067e-03, -7.09781790e-04, 9.12810373e-04, 8.02704089e-04,
    -1.12975431e-03, -4.51888682e-03, -8.60956810e-03, -1.24242528e-02, -1.49952903e-02, -1.56085316e-02, -1.39983992e-02, -1.04431355e-02,
    -5.73054277e-03, -9.94625065e-04, 2.54473443e-03, 3.88116782e-03, 2.48918669e-03, -1.50835661e-03, -7.32074422e-03, -1.36331865e-02,
    -1.88909028e-02, -2.16650834e-02, -2.10185516e-02, -1.67830657e-02, -9.67466402e-03, -1.20609702e-03, 6.60027685e-03, 1.16492722e-02,
    1.22713543e-02, 7.67423198e-03, -1.75846365e-03, -1.44010404e-02, -2.75861398e-02, -3.80498937e-02, -4.25459281e-02, -3.85116301e-02,
    -2.46523087e-02, -1.31871117e-03, 2.94102310e-02, 6.39713597e-02, 9.78551320e-02, 1.26344524e-01, 1.45319537e-01, 1.51975750e-01,
    1.45319537e-01, 1.26344524e-01, 9.78551320e-02, 6.39713597e-02, 2.94102310e-02, -1.31871117e-03, -2.46523087e-02, -3.85116301e-02,
    -4.25459281e-02, -3.80498937e-02, -2.75861398e-02, -1.44010404e-02, -1.75846365e-03, 7.67423198e-03, 1.22713543e-02, 1.16492722e-02,
    6.60027685e-03, -1.20609702e-03, -9.67466402e-03, -1.67830657e-02, -2.10185516e-02, -2.16650834e-02, -1.88909028e-02, -1.36331865e-02,
    -7.32074422e-03, -1.50835661e-03, 2.48918669e-03, 3.88116782e-03, 2.54473443e-03, -9.94625065e-04, -5.73054277e-03, -1.04431355e-02,
    -1.39983992e-02, -1.56085316e-02, -1.49952903e-02, -1.24242528e-02, -8.60956810e-03, -4.51888682e-03, -1.12975431e-03, 8.02704089e-04,
    9.12810373e-04, -7.09781790e-04, -3.56559067e-03, -6.88570691e-03, -9.82905147e-03, -1.16868994e-02, -1.20457682e-02, -1.08719728e-02,
    -8.50146259e-03, -5.54181545e-03, -2.71383278e-03, -6.73315268e-04, 1.43500780e-04, -3.85062841e-04, -2.05081274e-03, -4.38024478e-03,
    -6.76005696e-03, -8.59090131e-03, -9.43126902e-03, -9.09735319e-03, -7.69670493e-03, -5.59030150e-03, -3.29506515e-03, -1.35270585e-03,
    -1.97833735e-04, -5.71625524e-05, -9.02891150e-04, -2.46939695e-03, -4.32675914e-03, -5.99117026e-03, -7.04415270e-03, -7.23143398e-03,
    -6.51834394e-03, -5.08996726e-03, -3.29807551e-03, -1.56965669e-03, -3.00603379e-04, 2.39150860e-04, -3.35127753e-05, -1.00155763e-03,
    -2.38347679e-03, -3.80758359e-03, -4.90550529e-03, -5.40151637e-03, -5.17618858e-03, -4.28982792e-03, -2.96143740e-03, -1.50988604e-03,
    -2.72901333e-04, 4.75662615e-04, 5.90127237e-04, 8.38874212e-05, -8.79433199e-04, -2.03103270e-03, -3.06597612e-03, -3.71861728e-03,
    -3.82584012e-03, -3.36316579e-03, -2.44588656e-03, -1.29616281e-03, -1.85264723e-04, 6.34130452e-04, 9.88770485e-04, 8.24225674e-04,
    2.14006013e-04, -6.62773780e-04, -1.56865767e-03, -2.26767352e-03, -2.58272197e-03, -2.43664190e-03, -1.86751942e-03, -1.01540549e-03,
    -8.46684077e-05, 7.08004595e-04, 1.18679396e-03, 1.25812689e-03, 9.30581513e-04, 3.09216603e-04, -4.33397984e-04, -1.10157747e-03,
    -1.52498773e-03, -1.59922912e-03, -1.30892727e-03, -7.28321166e-04, -3.62861281e-18, 7.02256132e-04, 1.21691217e-03, 1.43358192e-03,
    1.31808002e-03, 9.18011381e-04, 3.48233051e-04, -2.39544920e-04, -6.95038888e-04, -9.05936178e-04, -8.23859940e-04, -4.73809697e-04,
    5.46213516e-05, 6.31445067e-04, 1.11942889e-03, 1.40778765e-03, 1.43818365e-03, 1.21698180e-03, 8.11283504e-04, 3.30311093e-04,
    -1.02770402e-04, -3.81365779e-04, -4.40770197e-04, -2.72321857e-04, 7.66387056e-05, 5.16451148e-04, 9.38601664e-04, 1.24287649e-03,
    1.36144117e-03, 1.27409518e-03, 1.01132727e-03, 6.44903767e-04, 2.68773609e-04, -2.46737590e-05, -1.67026731e-04, -1.29534812e-04,
    7.14963325e-05, 3.80499867e-04, 7.17769248e-04, 9.99843243e-04, 1.15997267e-03, 1.16367818e-03, 1.01580978e-03, 7.57738643e-04,
    4.55774605e-04, 1.83996741e-04, 5.91375397e-06, -4.05289186e-05, 4.89155015e-05, 2.45207683e-04, 4.94517500e-04, 7.32386569e-04,
    8.99864854e-04, 9.57606397e-04, 8.94580700e-04, 7.29514078e-04, 5.05029318e-04, 2.76232444e-04, 9.67708441e-05, 5.86865916e-06,
    1.94507266e-05, 1.27331055e-04, 2.96875861e-04, 4.81956152e-04, 6.34770959e-04, 7.17534187e-04, 7.11189351e-04, 6.19170679e-04,
    4.65526215e-04, 2.88121996e-04, 1.28809172e-04, 2.30860644e-05, -8.20958012e-06, 3.67434870e-05, 1.41215650e-04, 2.74870324e-04,
    4.01771459e-04, 4.89364163e-04, 5.16202740e-04, 4.76612389e-04, 3.81303109e-04, 2.53984029e-04, 1.24993789e-04, 2.36359947e-05,
    -2.88607255e-05, -2.40844845e-05, 3.21506671e-05, 1.21904873e-04, 2.20041142e-04, 3.00651845e-04, 3.43356649e-04, 3.37957499e-04,
    2.86408226e-04, 2.01755901e-04, 1.04458107e-04, 1.70922504e-05, -4.11903276e-05, -5.91182862e-05, -3.56441375e-05, 2.02832472e-05,
    9.23390749e-05, 1.61092591e-04, 2.08824079e-04, 2.23708650e-04, 2.02394492e-04, 1.50432887e-04, 8.05554617e-05, 9.30753536e-06,
    -4.70855292e-05, -7.65993874e-05, -7.41252123e-05, -4.24207434e-05, 8.85512241e-06, 6.57168497e-05, 1.13360603e-04, 1.39737726e-04,
    1.38343467e-04, 1.09588591e-04, 6.04787218e-05, 2.73438703e-06, -5.01531280e-05, -8.62012261e-05, -9.77659056e-05, -8.32660650e-05,
    -4.74237861e-05, -4.79110815e-19, 4.66419300e-05, 8.05450033e-05, 9.30182449e-05, 8.06740594e-05, 4.61739810e-05
])

def corregir_saltos_ppg(ppg_raw):
    datos_corregidos = []
    if len(ppg_raw) == 0: return []
    
    ultimo_valor_final = ppg_raw[0]
    datos_corregidos.append(ultimo_valor_final)

    for i in range(1, len(ppg_raw)):
        actual_raw = ppg_raw[i]
        diferencia_1 = ultimo_valor_final - actual_raw
        
        if diferencia_1 > 3000:
            paso_intermedio = actual_raw + 4096
        else:
            paso_intermedio = actual_raw
            
        diferencia_2 = ultimo_valor_final - paso_intermedio
        
        if diferencia_2 > 750:
            valor_final = paso_intermedio + 1024
        elif diferencia_2 < -750:
            valor_final = paso_intermedio - 1024
        else:
            valor_final = paso_intermedio
            
        datos_corregidos.append(valor_final)
        ultimo_valor_final = valor_final
        
    return datos_corregidos

class SignalProcessor:
    @staticmethod
    def apply_fir(x, coeffs):
        return lfilter(coeffs, 1.0, x)

    @staticmethod
    def moving_mean(x, n):
        if n <= 1: return x
        c = np.cumsum(np.insert(x, 0, 0.0))
        y = (c[n:] - c[:-n]) / n
        padl = n // 2
        padr = len(x) - len(y) - padl
        return np.pad(y, (padl, max(padr, 0)), mode='edge')

    @staticmethod
    def bandpass(x, fs, low, high, order=4):
        ny = 0.5 * fs
        sos = butter(order, [low/ny, high/ny], btype='band', output='sos')
        return sosfiltfilt(sos, x)

    @staticmethod
    def robust_z(x):
        med = np.median(x)
        mad = np.median(np.abs(x - med)) + 1e-12
        return (x - med) / (1.4826 * mad)

    @staticmethod
    def pick_peaks(x):
        distance = int(0.35 * 125)
        iqr = np.subtract(*np.percentile(x, [75, 25]))
        prom = max(0.2, 0.25 * iqr)
        return find_peaks(x, distance=distance, prominence=prom)

    @staticmethod
    def rr_from_baseline(ir_signal, fs=125):
        ir_no_trend = ir_signal - np.mean(ir_signal)
        sos = butter(2, [0.1, 0.5], btype='bandpass', fs=fs, output='sos')
        resp_signal = sosfiltfilt(sos, ir_no_trend)
        f, Pxx = welch(resp_signal, fs=fs, nperseg=len(resp_signal))
        
        valid_mask = (f >= 0.1) & (f <= 0.5)
        f_valid = f[valid_mask]
        Pxx_valid = Pxx[valid_mask]
        
        if len(Pxx_valid) == 0:
            return None
            
        peak_freq = f_valid[np.argmax(Pxx_valid)]
        rr_bpm = peak_freq * 60.0
        
        if 6 <= rr_bpm <= 35:
            return float(rr_bpm)
        else:
            return None

    @staticmethod
    def spo2_from_R(R, A=110.0, B=25.0):
        return float(np.clip(A - B * R, 70.0, 100.0))

    @staticmethod
    def estimate_spo2(ppg1, ppg2):
        red_ac_full = SignalProcessor.apply_fir(ppg1, FIR_COEFFS_SPO2)
        ir_ac_full = SignalProcessor.apply_fir(ppg2, FIR_COEFFS_SPO2)
        
        peaks, _ = find_peaks(ir_ac_full, distance=40, height=np.percentile(ir_ac_full, 70))
        
        if len(peaks) < 2:
            return 95.0 
        
        spo2_values = []
        
        for i in range(len(peaks) - 1):
            s, e = peaks[i], peaks[i+1]
            
            # AC del filtrado
            red_ac_rms = np.sqrt(np.mean(red_ac_full[s:e]**2)) + 1e-12
            ir_ac_rms = np.sqrt(np.mean(ir_ac_full[s:e]**2)) + 1e-12
            
            # DC del raw
            red_dc = np.mean(ppg1[s:e]) + 1e-12
            ir_dc = np.mean(ppg2[s:e]) + 1e-12
            
            R = (red_ac_rms / red_dc) / (ir_ac_rms / ir_dc)
            spo2_values.append(SignalProcessor.spo2_from_R(R))
            
        return np.mean(spo2_values) if spo2_values else 95.0

    @staticmethod
    def estimate_bpm(ppgA, ppgB):
        def get_q(sig):
            sig_filt = SignalProcessor.apply_fir(sig, FIR_COEFFS_BPM)
            sig_z = SignalProcessor.robust_z(sig_filt)
            p, props = SignalProcessor.pick_peaks(sig_z)
            return np.mean(props['prominences']) if len(p) else 0, p
        
        qA, pA = get_q(ppgA)
        qB, pB = get_q(ppgB)
        peaks = pB if qB > qA else pA
        
        if len(peaks) >= 2:
            intervals = np.diff(peaks) / 125
            valid = intervals[(intervals > 60/220) & (intervals < 60/40)]
            if len(valid): return 60.0 / np.median(valid)
        return None

def process_single_sequence(ppg_red, ppg_ir, temp):
    ppg_red = np.array(corregir_saltos_ppg(ppg_red), dtype=np.float32)
    ppg_ir = np.array(corregir_saltos_ppg(ppg_ir), dtype=np.float32)

    try: hr = SignalProcessor.estimate_bpm(ppg_red, ppg_ir)
    except: hr = None

    try: spo2 = SignalProcessor.estimate_spo2(ppg_red, ppg_ir)
    except: spo2 = None

    try: rr = SignalProcessor.rr_from_baseline(ppg_ir)
    except: rr = None

    sbp, dbp = None, None
    if BP_MODEL is not None:
        try:
            inp = ppg_red.reshape(1, -1)
            pred = BP_MODEL.predict(inp, verbose=0)[0]
            sbp, dbp = float(pred[0]), float(pred[1])
        except: pass

    return {"hr": hr, "spo2": spo2, "rr": rr, "temp": float(temp), "sbp": sbp, "dbp": dbp}